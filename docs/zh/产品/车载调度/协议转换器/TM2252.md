---
sidebar: heading
prev:
  text: 车载机产品列表
  link: /zh/产品/车载调度.md
---

# TM2252协议转换器

## 一、产品设计

![产品设计](/产品/车载调度/协议转换器/TM2252/产品设计.png )

## 二、线束

![线束](/产品/车载调度/协议转换器/TM2252/线束.png )

## 三、CAN接口

![CAN接口](/产品/车载调度/协议转换器/TM2252/CAN接口.png )

## 四、产品接口说明

![接口定义](/产品/车载调度/协议转换器/TM2252/接口定义.png )

### 1、指示灯说明

①、TM2252上电以后，绿灯P点亮，C1，C2，U灯会闪烁3次 若TM2252的P灯不亮，则说明TM2252电源异常。

②、TM2252上电以后，如果4个灯都是常亮表示协议转换器内没有程序，需要重新更新程序。

③、P是绿灯，绿灯亮，说明接通电源，协议转换可以正常工作；

④、红灯U闪烁，说明说明协议转换器RS232-2接口/RS485接收到数据。

⑤、红灯C1闪烁，说明说明协议转换器CAN1接口接收到数据。

⑥、红灯C2闪烁，说明说明协议转换器CAN2接口接收到数据。

### 2、接口说明

![接口说明](/产品/车载调度/协议转换器/TM2252/接口说明.png )

![接口说明-2](/产品/车载调度/协议转换器/TM2252/接口说明-2.png )

## 五、协议对接连接

### 1、CAN对接

![CAN对接](/产品/车载调度/协议转换器/TM2252/CAN对接.png )

### 2、卡机对接

![卡机对接](/产品/车载调度/协议转换器/TM2252/卡机对接.png )

### 3、第三方路牌对接

![第三方路牌对接](/产品/车载调度/协议转换器/TM2252/第三方路牌对接.png )

## 六、协议转换器版本查询

### 1、对接8707车载机

在车载机上按快捷键`010`，下翻查看`router ver`，目前这个功能TM8707的V4015和TM8706的V3066及之后的版本支持。

如果显示正常，证明协议转换器到车载机CAN网络正常；

若车载机显示V0000，有三种可能：

①、协议转换器没有上电。检测电源指示灯P是否亮；

②、车载机和协议转换器连接的CAN网络不通；

③、车载机滞后于协议转换器上电。同时上电或者协议转换器后上电可解决此问题。

![对接TM8707主机](/产品/车载调度/协议转换器/TM2252/对接TM8707主机.png )

### 2、对接TM872x/TM8731主机

在主页面按快捷键`消息 - 查询 - 125`，下翻查看协议转换器版本

![对接TM872x-TM8731主机](/产品/车载调度/协议转换器/TM2252/对接TM872x-TM8731主机.png )

### 3、对接TM8732/TM8760主机

`设置 - 参数 - 状态 - 对接设备 - 协议转换器软件版本`

![对接TM8732-TM8760主机](/产品/车载调度/协议转换器/TM2252/对接TM8732-TM8760主机.png )

## 七、程序升级

### 1、电脑升级

#### ①、升级工具准备

* 电脑

* USB线束

* 线刷板：串口信号引出3孔插件，对接协议转换器RS232-1接口

* 线刷软件：flymcu

* 要烧写的程序

![USB线束](/产品/车载调度/协议转换器/TM2252/USB线束.png =300x)&nbsp;
![线刷板](/产品/车载调度/协议转换器/TM2252/线刷板.png =398x244)

#### ②、线束短接

> 上排2和4短路后，上电后协议转换器只亮一个绿灯表示短路成功，协议转 换器已经进入编程模式

![线束短接](/产品/车载调度/协议转换器/TM2252/线束短接.png =400x)

#### ③、线刷接口RS232-1

![RS232-1接口](/产品/车载调度/协议转换器/TM2252/RS232-1接口.png =400x)

#### ④、线刷软件线刷步骤

![flymcu软件](/产品/车载调度/协议转换器/TM2252/flymcu软件.png )

![flymcu软件线刷步骤](/产品/车载调度/协议转换器/TM2252/flymcu软件线刷步骤.png =360x)&nbsp;
![flymcu软件升级完成](/产品/车载调度/协议转换器/TM2252/flymcu软件升级完成.png =360x)

⑤、去掉短接线

> 升级完成后，将协议转换器断电，将2孔和4孔的短路线拔掉，重新接上电源，三个红灯一起闪烁三次，表示已经升级成功。

![线刷完成](/产品/车载调度/协议转换器/TM2252/线刷完成.png =400x)

### 2、手持编程器升级

![手持编程器](/产品/车载调度/协议转换器/TM2252/手持编程器.png =400x)

#### Ⅰ、将程序下载到手持编程器

①、用usb连接电脑，选择`连接PC`

②、电脑上打开EP968文件夹

③、右键点击`ep968.exe`，选择`以管理员身份打开`

④、搜索手持机

![搜索手持机](/产品/车载调度/协议转换器/TM2252/搜索手持机.png =400x)

⑤、查看手持机中的文件，找一个要下载的位置

⑥、选择芯片型号，`STM32F105XXX` 

![选择芯片](/产品/车载调度/协议转换器/TM2252/选择芯片.png =400x)

⑦、点击`生成不加密的ppf并下载到EP968手持机`

![选择程序文件](/产品/车载调度/协议转换器/TM2252/选择程序文件.png =288x287)&nbsp;
![选择下载位置](/产品/车载调度/协议转换器/TM2252/选择下载位置.png =427x286)

#### Ⅱ、手持编程器选择固件

①、手持编程器回到主界面

②、按住`按键8`不要松开，EP968将重启进入`手持机固件管理器`

③、选择菜单第二项`更换固件` ，选择`STM32_ISP`固件即可。

#### Ⅲ、手持编程器升级程序

①、和电脑升级一样，短接协议转换器线束上排2、4接口，使用线刷板连接协议转换器RS232-1接口。

②、将协议转换器断电。

③、手持编程器选择下载好的文件，点击升级。

④、将协议转换器上电即可自动升级。

### 3、FTP升级

#### Ⅰ、准备远程升级文件

> 准备好要升级的程序文件（xxx.bin文件是需要远程升级的程序文件）

![远程升级文件](/产品/车载调度/协议转换器/TM2252/远程升级文件.png )

#### Ⅱ、重命名文件

> 重命名xxx.bin文件，去掉 .bin后缀，升级时候协议转换器会比较当前版本和要升级的版本，版本不一致才会升级。
>
> * HW3003：表示硬件版本
>
> * SW2186：表示软件版本

![修改文件名称](/产品/车载调度/协议转换器/TM2252/修改文件名称.png )

#### Ⅲ、新建update_per文件夹

> 将修改好的程序文件放入，并创建`inf.txt`和`per_update`文件。
>
> * inf.txt：配置文件
>
> * per_update：协议转换器升级需要的配置文件（空文件）
>
> * TM2252-HW3003-SW2186：要升级的程序文件

![升级文件目录](/产品/车载调度/协议转换器/TM2252/升级文件目录.png )

#### Ⅳ、打开`inf.txt`文件，输入以下内容

> 说明：
>
> * canid:C5000001---------->协议转换器在CAN网络中的ID
>
> * filename:TM2252-HW3003-SW2186 ----------->要升级的程序文件名称

![inf文件内容](/产品/车载调度/协议转换器/TM2252/inf文件内容.png )

#### Ⅴ、将`update_per`文件压缩成`update_per.zip` 

![压缩升级包](/产品/车载调度/协议转换器/TM2252/压缩升级包.png )

#### Ⅵ、GPS调度页面远程下发

* 在FTP上创建文件夹（设备名称 - 程序版本），将程序放进去。

![FTP新建目录](/产品/车载调度/协议转换器/TM2252/FTP新建目录.png =340x)&nbsp;
![FTP程序文件](/产品/车载调度/协议转换器/TM2252/FTP程序文件.png =348x216)

* 登录智能调度页面，进入FTP升级页面选择要升级的车辆下发升级。

![智调页面下载](/产品/车载调度/协议转换器/TM2252/智调页面下载.png )

## 八、配置仪表协议

### 1、准备工作

| 准备工作 | 必要条件 |
| --- | --- |
| 平台 | 智能调度页面 -> 仪表管理 -> 仪表方案配置 |
| 确认车载设备是否支持 | 1、TM8730、TM8732和TM8760及以后出的新设备支持此功能，TM8707，TM8720、TM8731不支持此功能。<br /><br />2、TM8732、TM8760设备，程序版本：单片机V3004及以后版本，核心板TM8732-8832核心板-V041029程序（高清）-190105及以后版本<br /><br />3、TM8730设备，V10013版本及以后版本<br /><br />4、协议转换器，V3001及以后版本，版本后标注的有`仪表可配置` |
| 协议文件 | 1、新车一般是找张宏飞要车辆仪表协议<br />2、改造车一般是要公交协调客车厂要仪表协议 |
| 上传项目 | 与客户确认后台需要上传到平台的仪表项目 |

### 2、FTP信息配置

> 打开智调页面，选择`仪表管理 - FTP配置信息`

![FTP信息配置](/产品/车载调度/协议转换器/TM2252/FTP信息配置.png )

### 3、仪表方案配置

> * 方案名称：推荐设置【地市名称+车型+仪表+年代】的方式， 例如“许昌雪利曼2021”
>
> * 版本信息：推荐用方案名称的英文或拼音，然后加上版本号；例如：“XuChang_XueLiMan_V1.0”；
>
> * 解析类型：默认01

![仪表方案配置](/产品/车载调度/协议转换器/TM2252/仪表方案配置.png )

### 4、详细配置界面

> 点击新增方案前的`详细`按钮，进入到详细配置界面。

![详细配置界面-1](/产品/车载调度/协议转换器/TM2252/详细配置界面-1.png )

![详细配置界面-2](/产品/车载调度/协议转换器/TM2252/详细配置界面-2.png )

### 5、添加仪表协议

> 在数据项的选择界面。根据上下翻页，查找到需要添加的数据项，然后在左边勾选，单个或多个添加至右边列表。

![详细配置界面-3](/产品/车载调度/协议转换器/TM2252/详细配置界面-3.png )

### 6、填写仪表数据

![仪表协议](/产品/车载调度/协议转换器/TM2252/仪表协议.png )

> 配置选项说明：
>
> * CAN_ID：为数据项所在的仪表CANID，格式中字母不区分大小写，建议大写，例如“18F40217”，不足8位高位补0；
>
> * 大小端选择：默认为小端，可以根据仪表协议中该数据项的实际大小端格式进行选择，目前来说，大部分的仪表数据格式均为小端；
>
> * 节点选择：为数据项所在字段的区域选择。若数据项为多个连续位，点击起始和结束位即可，若数据项仅一个位，起始位和结束位一致，点击两次即可；
>
> * 分辨率：仪表协议中的分辨率，如实填写；
>
> * 偏移量：仪表协议中的偏移量，如实填写；若存在负值，写上负号“-”，如仪表协议中的偏移量为-40，则在此填写“-40”；
>
> * 匹配单位：根据仪表协议，需要如实选择。
>
> * 是否为车载机数据项：用来选择是否要车载机单独解析作为车载机其他业务数据源。目前车载机使用的量有车速、左右转灯、刹车、倒车、危急报警，其他暂未作要求。

①、输入CAN_ID

![输入CAN_ID](/产品/车载调度/协议转换器/TM2252/输入CAN_ID.png )

②、选择节点位置（示例中：默认小端）：【按照仪表协议，选择1 - 4字节】

![节点选择](/产品/车载调度/协议转换器/TM2252/节点选择.png )

③、输入分辨率0.125、偏移量0、匹配单位km，输入完成后保存即可：

![分辨率](/产品/车载调度/协议转换器/TM2252/分辨率.png )

④、其他协议示例

![仪表协议配置示例](/产品/车载调度/协议转换器/TM2252/仪表协议配置示例.png )

### 7、配置文件生成

仪表数据项配置完成并保存后，点击`上传ftp`按钮，完成文件的生成和上传，同时，对应FTP压缩文件框会显示生成的文件名称。

> “附件”上传，可以将相应的仪表协议文档，上传至平台，以便后期便于查阅、校正等

![配置文件上传](/产品/车载调度/协议转换器/TM2252/配置文件上传.png )

### 8、FTP升级

* FTP目录：FTP信息配置的目录----根据实际存储目录设置；

* FTP文件名：update_file_per.zip --- 此文件名不能更改；

![仪表文件ftp升级](/产品/车载调度/协议转换器/TM2252/仪表文件ftp升级.png )

![仪表文件ftp升级-2](/产品/车载调度/协议转换器/TM2252/仪表文件ftp升级-2.png )

![仪表文件ftp升级-3](/产品/车载调度/协议转换器/TM2252/仪表文件ftp升级-3.png )

### 9、U盘升级

#### ①、下载仪表配置文件

![仪表文件U盘升级-1](/产品/车载调度/协议转换器/TM2252/仪表文件U盘升级-1.png )

#### ②、修改U盘升级文件

> 目录：`U盘：/tmkj_update/per`，将下载的文件`update_file_per`放入`per`文件夹中，并将`update_file_per`重命名为方案名称。

![重命名方案名称](/产品/车载调度/协议转换器/TM2252/重命名方案名称.png =231x138)&nbsp;
![重命名方案名称-2](/产品/车载调度/协议转换器/TM2252/重命名方案名称-2.png =446x140)

#### ③、TM8730升级

> U盘插入TM8730设备USB口，依次点击“设置”->"文件管理"->"仪表配置文件导入"

![TM8730升级](/产品/车载调度/协议转换器/TM2252/TM8730升级.png )

#### ④、TM8732/TM8760升级

U盘插入车载机USB口，进入文件管理界面，选择参数维护，点击协议转换器参数导入。

![TM8732-TM8760升级](/产品/车载调度/协议转换器/TM2252/TM8732-TM8760升级.png )

### 10、报文上传说明

①、开关类、报警类数据：变化量1s传输一次，全量5分钟上传一次。

②、状态类、数据类数据：全量15s上传一次。

③、协议转换器仪表配置文件下载并存储后，每次上电启动后，都将上传仪表配置信息上传至后台服务，每20s重发一次，直至接收到后台服务器应答，才停止重发；并且，只有接收到后台应答后，才会上传开关量、报警类、状态类、仪表数据类数据。

④、前端高速can网络超过10s无数据，协议转换器则不再上传。

⑤、前端高速can数据超过3min无数据，协议转换器将清空缓存。

### 11、仪表配置故障排查

查看协议转换器中的仪表配置信息

> 将串口线插入到RS232-1接口，配置COM口，波特率选择38400，语言选择UTF8，将协议转换器断电，再上电即可看到配置文件。

**以下为正常的配置文件：**

![仪表正常配置文件](/产品/车载调度/协议转换器/TM2252/仪表正常配置文件.png )

**以下为不正常的配置文件：**

![仪表错误配置文件](/产品/车载调度/协议转换器/TM2252/仪表错误配置文件.png )

**仪表配置文件解析失败原因：**

**1、 U盘升级时的文件名和版本名要一样。**

![重命名方案名称](/产品/车载调度/协议转换器/TM2252/重命名方案名称.png )

**2、 配置文件内容不正确，需要仔细核对CAN协议。**

**3、 协议转换器版本要刷成V3000以上。**